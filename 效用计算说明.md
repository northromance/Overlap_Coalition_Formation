# 联盟效用计算说明

## 核心改进

### 问题描述
原先的 `calculate_coalition_utilities.m` 使用 `overlap_coalition_self_utility` 函数计算联盟效用，该函数基于智能体的**信念**计算期望需求和期望价值。但在最终评估联盟效用时，应该使用任务的**实际需求和实际价值**，而不是智能体的主观估计。

### 解决方案

#### 1. 新建函数：`overlap_coalition_self_utility_actual.m`
创建了一个新的效用计算函数，与原函数的主要区别：

| 方面 | 原函数（期望） | 新函数（实际） |
|------|--------------|--------------|
| **资源需求** | 基于智能体信念的期望需求 | 任务的实际资源需求 |
| **任务价值** | 基于智能体信念的期望价值 | 任务的实际价值 |
| **用途** | SA算法中的决策（智能体视角） | 最终效用评估（真实结果） |

核心公式相同：
```
utility_n(C) = r_n(C) × V_C × D_C - (t_wait × α + T_exec × β)
```

但参数来源不同：
- **期望版本**：V_C 和 D_C 基于信念计算
- **实际版本**：V_C 和 D_C 基于真实值计算

#### 2. 修改 `calculate_coalition_utilities.m`
- 调用新函数 `overlap_coalition_self_utility_actual` 而不是原函数
- 使用实际需求和价值计算联盟效用
- `Value_data` 参数保留以维持接口兼容性

#### 3. 新增对比可视化：`plot_utility_comparison.m`
创建对比图表，同时展示：
- 基于实际需求的联盟效用（实线）
- 基于期望需求的联盟效用（虚线）
- 两者的差异统计

## 运行结果示例

从输出可以看到明显的差异：

### 初始阶段
- **期望需求效用**：4850.4（智能体过高估计）
- **实际需求效用**：1996.2（真实效用）
- **差异**：-2854.2

### 最终阶段
- **期望需求效用**：2184.5（智能体估计趋于准确）
- **实际需求效用**：2040.1（真实效用）
- **差异**：-144.4

### 关键发现
1. **初始阶段**：智能体对任务价值和需求的估计不准确，导致期望效用远高于实际效用
2. **学习过程**：随着观测增加，智能体的信念逐渐接近真实情况
3. **最终收敛**：期望效用与实际效用的差距显著缩小（从-2854.2缩小到-144.4）

## 文件清单

### 新增文件
1. `SA/overlap_coalition_self_utility_actual.m` - 基于实际需求的效用计算函数
2. `plot_utility_comparison.m` - 效用对比可视化函数

### 修改文件
1. `SA/calculate_coalition_utilities.m` - 改用实际需求版本的效用函数
2. `Main.m` - 添加对比图表的调用

### 输出图表
1. 联盟演化和任务完成度（原有）
2. 各任务联盟效用演化图（基于实际需求）
3. **效用对比图**（实际 vs 期望，新增）
4. 智能体任务分配与资源使用图

## 使用说明

直接运行 `Main.m`，程序会自动：
1. 运行SA算法形成联盟
2. 计算基于实际需求的联盟效用
3. 生成4个可视化图表
4. 打印详细的效用对比摘要

所有计算自动完成，无需额外配置。
